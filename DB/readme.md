# Database Management System

이 프로젝트는 회원 관리 및 리워드 시스템을 위한 데이터베이스 작업을 처리하는 Python 기반 시스템입니다. `Database` 클래스에서 여러 데이터베이스 작업을 관리하며, SQLite를 사용하여 데이터베이스에 연결하고 다양한 기능을 제공합니다.

# SQLite3 기반 DB구현
* 가상환경에 requirement_db.txt 설치 할 것
```
pip install -r requirement_db.txt
```

# 파일 간단 설명
* sqlite3_db.py : DB생성 및 제어를 위한 함수
* check_db.py : DB 구현 내용 테스트 

# 기능

## [Class Database]
### 1. **회원 관리**

- **새로운 회원 등록**: 사용자가 시스템에 처음 가입할 때, 회원 정보를 `Membership` 테이블에 추가합니다.
- **기존 회원 조회**: 이미 가입된 회원의 정보를 조회할 수 있습니다.
- **회원의 리워드 상태 조회**: 회원의 리워드 포인트 및 리워드 타입을 조회합니다.

### 2. **주문 처리**

- **주문 추가**: 회원의 주문 정보를 `Orders` 테이블에 추가합니다.
- **리워드 시스템 업데이트**: 주문을 처리할 때마다 리워드 포인트를 업데이트합니다.

### 3. **리워드 시스템**

- **리워드 포인트 계산**: 회원의 주문 내역을 바탕으로 리워드 포인트를 계산하고 업데이트합니다.
- **리워드 사용 가능 여부 확인**: 회원의 리워드 포인트가 충분한지 확인하고, 사용 가능한 경우에만 리워드를 제공합니다.

### 4. **얼굴 인식** (Optional)

- **첫 번째 얼굴 인식**: 회원의 얼굴을 인식하여 기존에 등록된 회원 정보를 조회하고 리워드 상태를 반환합니다.


## [Class AI_Connect]
### 1. **AI 서버와의 소켓 통신**

- **소켓 연결**: `AI_Connect` 클래스의 `socket_connect` 메서드를 통해 AI 서버와의 소켓 연결을 설정하고, 연결을 유지합니다.
- **메시지 수신**: 서버와 연결된 후, 소켓을 통해 메시지를 수신하며, 수신된 메시지가 유효한지 확인합니다.

### 2. **사고 기록 관리**

- **사고 기록 저장**: 수신된 메시지가 `incident`일 경우, 사고 정보를 `Robot_incident` 데이터베이스에 기록합니다.
- **사고 기록의 고유 ID 생성**: 사고 기록을 저장할 때마다 새로운 고유 ID를 생성하고, 이를 데이터베이스에 삽입하는 작업을 수행합니다.

### 3. **AI 시스템의 메시지 처리**

- **사고 정보 처리**: 수신된 사고 정보 메시지(`incident`)를 처리하여, 해당 정보를 `incident_record` 메서드를 통해 데이터베이스에 저장하고, 저장 완료 메시지를 서버에 전송합니다.
- **기타 메시지 처리**: 사고 정보 외에도 `cleanliness`와 같은 다른 메시지 타입을 수신하여 적절하게 처리. 예를 들어, 테이블 청결 정보를 수신하고 이를 다른 시스템에 전달할 수 있습니다.

### 4. **서버 연결 재시도 및 예외 처리**

- **소켓 연결 재시도**: 연결이 끊어지거나 타임아웃이 발생하면, 자동으로 서버와의 재연결을 시도합니다.
- **예외 처리**: 메시지 수신 중 예외가 발생하면 예외를 처리하고, 연결을 끊고 다시 연결을 시도하는 로직이 포함됩니다.

### 5. **멀티스레딩 및 비동기 처리**

- **스레드 관리**: `socket_connect` 메서드는 별도의 스레드에서 실행되어 AI 서버와의 연결을 비동기적으로 처리합니다. 이를 통해 메시지를 수신하는 동안 다른 작업이 차단되지 않고 병렬로 수행되도록 합니다.

---

## 클래스 및 주요 메서드

### `Database` 클래스

`Database` 클래스는 SQLite 데이터베이스에 연결하고, 회원 관리 및 리워드 시스템 관련 작업을 처리하는 기능을 제공합니다.

#### Method
- **`socket_connect()`**: 데이터베이스 연결을 설정
- **`db_new_member()`**: 새로운 회원을 등록하거나 기존 회원 정보를 조회
- **`init_database()`**: 데이터베이스 및 테이블을 초기화
- **`db_update_order()`**: 주문을 추가하고, 회원의 경우 리워드 포인트를 업데이트
- **`update_order_history()`**: 회원의 주문 정보를 기반으로 선호 기록을 업데이트
- **`add_new_member()`**: 신규회원을 DB에 업데이트
- **`db_first_face_recognition()`**: 얼굴 인식된 회원의 정보를 조회
- **`is_member()`**: 기존 가입된 회원인지 확인
- **`update_member_prefer_rewards()`**: 회원의 리워드 정보를 업데이트
- **`greeting_member()`**: 회원 맞춤 응대를위해 회원의 구매 및 선호정보 반환


### `AI_Connect` 클래스

`AI_Connect` 클래스는 AI 서버와의 소켓 연결 및 사고 기록 관리 기능을 제공합니다.

#### Method
- **`socket_connect()`**: AI 서버와 소켓 연결을 설정하고 메시지를 수신합니다. 연결이 끊어지면 재연결
- **`incident_record()`**: 수신된 사고 정보를 `Robot_incident` 데이터베이스에 저장
- **`get_incident_last_index()`**: 마지막 사고 기록의 ID를 조회하여 새로운 사고 기록의 ID를 생성
- **`send_response()`**: 클라이언트에게 메시지 처리 결과를 전송

